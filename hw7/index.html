<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MY Web Push</title>
    <script>
        const publicVapidKey = "Wlcy1pgDk3u9IXwwQJiJk2JBiN7bYNgnv0xKkEOPSM0R6QRr730b8Tv-b5MaKDjkLXVcQ4_SRlk7TMhwzOQYig==";

        async function register() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('Service Worker Registered', registration);

                    await subscribe(registration);
                } catch (e) {
                    console.error('Service Worker Registration Failed', e);
                }
            } else {
                console.error('Service Worker is not supported in this browser.');
            }
        }

        async function subscribe(registration) {
            try {
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlB64ToUint8Array(publicVapidKey),
                });
                console.log('Subscribed to Push Notifications', subscription);

                await fetch('/push', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Subscription registered on the server.');

            } catch (e) {
              console.error('Subscription to Push Notifications failed', e);
            }
        }

        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
          
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
          
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        register();
    </script>
</head>
<body>
    <h1>Web Push Example</h1>
    <button onclick="fetch('/send-push', { method: 'POST' })">Send Push</button>
</body>
</html>